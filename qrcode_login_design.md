
# 扫码登录业务逻辑设计

扫码登录技术逻辑梳理(参考的微博， 爱奇艺， b站的)

1. web 刷新页面，服务端生成唯一token值(例如md5生成)， 放到redis缓存中， key-value格式， 比如设置过期时间300s, 返回前端token.

2. 前端js根据token值，指定扫码跳转URL， 去生成二维码
    1. 这里URL参数可以追加一些附加属性， 比如扫码所属的页面， 扫码所属的页面位置等额外统计信息

3. 前端ajax定时轮询 服务端接口，偏状态机， 目的
    1. 询问客户端是否已经扫码完成
    2. 询问是否超时，超时则提示需要刷新二维码
    3. 询问是否扫码成功， 提示扫码成功
    4. 询问是否登录成功， 提示登录成功
    5. 询问是否取消， 取消则同样提示刷新二维码

4. 客户端扫码，注入登录cookie, h5页面确认是否登录
    1. 未登录， js引导客户端去原生登录
    2. 已经登录， 引导用户操作
        1. 确认登录button
            携带登录信息， 请求后端接口， 将token和用户ID进行绑定
        2. 取消授权
            请求后端接口，主动删除token

5. web轮询， 登录成功时
    1. 根据token获取user_id
    2. 根据user_id 生成登录cookie， 插入登录log日志
    3. 告诉前端登录成功， 刷新页面

核心点：

* 存储：

	redis缓存中存放 token 值， token 和user_id 进行绑定， 直接key-value格式即可

* web端选择轮询方式原因：

	可以直接set-cookie 进行登录cookie设置