### dns协议解析理解

本文主要用于理解dns协议，先概念，后实践

### dns概念

### 为什么需要dns协议

 网络通讯大部分是基于TCP/IP的，而TCP/IP是基于IP地址的，所以计算机在网络上进行通讯时只能识别如“202.96.134.133”之类的IP地址，而不能认识域名。我们无法记住10个以上IP地址的网站，所以我们访问网站时，更多的是在浏览器地址栏中输入域名，就能看到所需要的页面，这是因为有一个叫“DNS服务器”的计算机自动把我们的域名“翻译”成了相应的IP地址，然后调出IP地址所对应的网页。
 
#### 一句话描述dns协议

> 维基百科：Domain Name System 将域名和IP地址相互映射的一个分布式数据库，能够使人更方便地访问互联网


我们主要的应用场景是：是根据域名获取IP， 但一些特殊场景下，也可以根据指定IP获取域名。

####dns域名空间结构

域名系统作为一个层次结构和分布式数据库，包含各种类型的数据，包括主机名和域名。DNS数据库中的名称形成一个分层树状结构称为域命名空间。 ， 这里如图展示

我们一般域名构造以下形式：

 `[可选三级域名].主机名.次级域名.顶级域名.根域名`
 
 我们可以举例说明
 
  针对 www.baidu.com域名
 
 www ------->代表三级域名
 
 smzdm ----->代表次顶级域名
 
 com ------>代表顶级域名
 
 一般情况我们把根域名`.`省略了
 
 不同的域名由不同的域名服务器管理， 比如 根域名由根服务器管理， 顶级域名由顶级服务器管理
 


####dns查找流程

当我们在浏览器输入域名， 主要查找流程简述如下：

1. 先检查浏览器缓存中 是否有对应的  domain:ip映射缓存， 如果有， 直接返回

2. 检查/etc/hosts文件 中是否有对应的 domain:ip映射缓存， 如果有，直接返回

3. 【递归查询】本地 /etc/resolv.conf 文件指定的域名服务器， 如果有，直接返回

主要伪代码如下：

```
server_ip = getIpByDomain(domain)
{   
    //本地dns缓存， 比如chrome浏览器缓存
    if(system_cached_match(domain))
    {
        return server_ip
    } else if (system_host_file_match(domain)) //匹配本地/etc/host文件
    {
        return server_ip
    } else if (reverse_request_namespace_server_by_resolv-conf(domain)) // 【递归查询】本地 /etc/resolv.conf 指定的域名服务器
    {
        return server_ip
    } else {
        //错误
    }
    //请求namespace server 
    //处理逻辑    
}
```

步骤1，2主要是为了提高 查找命中率， 这里不多说， 我们主要看步骤3是如何操作的

我们可以查看resolv.conf文件内容

```
➜  ~ cat /etc/resolv.conf
#
# Mac OS X Notice
#
# This file is not used by the host name and address resolution
# or the DNS query routing mechanisms used by most processes on
# this Mac OS X system.
#
# This file is automatically generated.
#
nameserver 192.168.50.1 # 这里即是本地指定的dns服务器，开发环境下， 一般是我们路由的IP
```

#### 递归查询理解
 
 客户端 请求本地nameserver是递归方式， 如下展示todo
 
 
 
 nameserver请求根服务器，一般是迭代方式， 如图todo：
 
 
 
 根服务器IP(hint zone file)一般内置在跟服务器中
 
 但大部分本地域名解析服务器，只做转发服务， 比如转发到google权威服务器 8.8.8.8
 
 


大部分时候，都会将domain+IP临时缓存下来， 用来提高效率


#### DNS资源类型简介

我们在域名服务器上， 不只看看到 domain和 IP的映射关系， 还有一些其他属性， 统称为资源记录类型，都有以下几种

A  	记录	domain -> ipv4, 记录域名到ipv4的映射关系， 即我们最终想要的domain-->map的映射关系

AAAA 	记录	domain -> ipv6， 记录域名到ipv6的映射关系

NS 	记录	标明当前区域的NS服务器是谁，

MX 	记录	标明当前域内谁是邮件服务器

PTR 	记录	ip -> domain, 记录IP到ipv4的映射关系

SOA 	记录	一个解析库有且只有一个SOA记录,且必须为解析库的第一条记录， 主要用于`同步从库`使用

CNAME	记录	别名， 记录主要用于域名的内部跳转，为服务器配置提供灵活性，用户感知不到。


####开发常用命令

##### 1. dig命令

常见使用命令

`dig www.baidu.com`

```
➜  ~ dig www.baidu.com

; <<>> DiG 9.8.3-P1 <<>> www.baidu.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61608
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION: ============这里是我们发起请求
;www.baidu.com.			IN	A ========这里是我们希望获取到域名的Address

;; ANSWER SECTION: ==============返回值
www.baidu.com.		954	IN	CNAME	www.a.shifen.com. 
www.a.shifen.com.	52	IN	A	61.135.169.125
www.a.shifen.com.	52	IN	A	61.135.169.121

;; Query time: 16 msec
;; SERVER: 192.168.50.1#53(192.168.50.1)
;; WHEN: Sun Jan 13 22:10:17 2019
;; MSG SIZE  rcvd: 90
```

指定域名服务器

`dig www.baidu.com @8.8.8.8`

```
➜  ~ dig www.baidu.com @8.8.8.8

; <<>> DiG 9.8.3-P1 <<>> www.baidu.com @8.8.8.8
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 41513
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;www.baidu.com.			IN	A

;; ANSWER SECTION:
www.baidu.com.		789	IN	CNAME	www.a.shifen.com.
www.a.shifen.com.	78	IN	A	61.135.169.125
www.a.shifen.com.	78	IN	A	61.135.169.121

;; Query time: 220 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Sun Jan 13 22:12:21 2019
;; MSG SIZE  rcvd: 90
```

我们可以通过迭代方式，直接请求跟服务器查看结果

`dig +trace www.baidu.com`

输出结果：

```
➜  ~ dig +trace www.baidu.com

; <<>> DiG 9.8.3-P1 <<>> +trace www.baidu.com
;; global options: +cmd
.			444507	IN	NS	i.root-servers.net.
.			444507	IN	NS	j.root-servers.net.
.			444507	IN	NS	b.root-servers.net.
.			444507	IN	NS	d.root-servers.net.
.			444507	IN	NS	e.root-servers.net.
.			444507	IN	NS	a.root-servers.net.
.			444507	IN	NS	h.root-servers.net.
.			444507	IN	NS	m.root-servers.net.
.			444507	IN	NS	c.root-servers.net.
.			444507	IN	NS	k.root-servers.net.
.			444507	IN	NS	f.root-servers.net.
.			444507	IN	NS	g.root-servers.net.
.			444507	IN	NS	l.root-servers.net.
;; Received 228 bytes from 192.168.50.1#53(192.168.50.1) in 26 ms

com.			172800	IN	NS	a.gtld-servers.net.
com.			172800	IN	NS	b.gtld-servers.net.
com.			172800	IN	NS	c.gtld-servers.net.
com.			172800	IN	NS	d.gtld-servers.net.
com.			172800	IN	NS	e.gtld-servers.net.
com.			172800	IN	NS	f.gtld-servers.net.
com.			172800	IN	NS	g.gtld-servers.net.
com.			172800	IN	NS	h.gtld-servers.net.
com.			172800	IN	NS	i.gtld-servers.net.
com.			172800	IN	NS	j.gtld-servers.net.
com.			172800	IN	NS	k.gtld-servers.net.
com.			172800	IN	NS	l.gtld-servers.net.
com.			172800	IN	NS	m.gtld-servers.net.
;; Received 491 bytes from 199.7.83.42#53(199.7.83.42) in 29 ms

baidu.com.		172800	IN	NS	dns.baidu.com.
baidu.com.		172800	IN	NS	ns2.baidu.com.
baidu.com.		172800	IN	NS	ns3.baidu.com.
baidu.com.		172800	IN	NS	ns4.baidu.com.
baidu.com.		172800	IN	NS	ns7.baidu.com.
;; Received 201 bytes from 192.55.83.30#53(192.55.83.30) in 434 ms

www.baidu.com.		1200	IN	CNAME	www.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns5.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns2.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns1.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns4.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns3.a.shifen.com.
;; Received 228 bytes from 220.181.37.10#53(220.181.37.10) in 33 ms
```

输出SOA信息

`dig www.baidu.com SOA`

##### 2. host命令

常用命令

` host www.baidu.com`

输出结果：

```
➜  ~ host www.baidu.com
www.baidu.com is an alias for www.a.shifen.com.
www.a.shifen.com has address 61.135.169.121
www.a.shifen.com has address 61.135.169.125
```
返回详细信息

`host -v www.baidu.com`

输出结果

```
➜  ~ host -v www.baidu.com
Trying "www.baidu.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 60663
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;www.baidu.com.			IN	A

;; ANSWER SECTION:
www.baidu.com.		139	IN	CNAME	www.a.shifen.com.
www.a.shifen.com.	155	IN	A	61.135.169.121
www.a.shifen.com.	155	IN	A	61.135.169.125

Received 93 bytes from 192.168.50.1#53 in 9 ms
Trying "www.a.shifen.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3415
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0

;; QUESTION SECTION:
;www.a.shifen.com.		IN	AAAA

;; AUTHORITY SECTION:
a.shifen.com.		30	IN	SOA	ns1.a.shifen.com. baidu_dns_master.baidu.com. 1901080048 5 5 2592000 3600

Received 97 bytes from 192.168.50.1#53 in 5 ms
Trying "www.a.shifen.com"
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36779
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0

;; QUESTION SECTION:
;www.a.shifen.com.		IN	MX

;; AUTHORITY SECTION:
a.shifen.com.		30	IN	SOA	ns1.a.shifen.com. baidu_dns_master.baidu.com. 1901080048 5 5 2592000 3600

Received 97 bytes from 192.168.50.1#53 in 5 ms
```

指定域名服务器

`host -v www.baidu.com 8.8.8.8`

### 搭建dns服务器

为了更好的理解dns服务器的工作基本原理， 我尝试搭建了一套dns服务器


#### 前提环境

ubuntu:16.04

bind9

#### 具体搭建流程

- 执行软件安装

`sudo apt-get install bind9 bind9utils bind9-doc`

bind9常用命令

重启

`sudo service bind9 restart`

查看状态

`sudo service bind9 status`

开始，暂停

`sudo service bind9 start/stop`


bind9运行主要监听53端口， 我搭建的服务器IP是: 192.168.50.245

可以通过netstat查看端口占用情况

`netstat -tln | grep 53`


- 修改配置文件， 支持ipv4模式

`> sudo vi /etc/default/bind9`

```
OPTIONS="-4 -u bind"
```

- bind9主要配置文件一览

对于bind9的主要配置文件`/etc/bind/named.conf`, 我们打开查看

```
// This is the primary configuration file for the BIND DNS server named.
//
// Please read /usr/share/doc/bind9/README.Debian.gz for information on the
// structure of BIND configuration files in Debian, *BEFORE* you customize
// this configuration file.
//
// If you are just adding zones, please do that in /etc/bind/named.conf.local

include "/etc/bind/named.conf.options"; #主要是全局配置相关
include "/etc/bind/named.conf.local"; #主要加载对应zone
include "/etc/bind/named.conf.default-zones"; #默认zone
```

语法类似nginx.conf, 主要是加载了三个文件， 我们分别来看

`named.conf.options`文件


```
options {
    directory "/var/cache/bind";

    // If there is a firewall between you and nameservers you want
    // to talk to, you may need to fix the firewall to allow multiple
    // ports to talk.  See http://www.kb.cert.org/vuls/id/800113

    // If your ISP provided one or more IP addresses for stable
    // nameservers, you probably want to use them as forwarders.
    // Uncomment the following block, and insert the addresses replacing
    // the all-0's placeholder.

    // forwarders {
    //  0.0.0.0;
    // };

    //========================================================================
    // If BIND logs error messages about the root key being expired,
    // you will need to update your keys.  See https://www.isc.org/bind-keys
    //========================================================================
    dnssec-validation auto;

    auth-nxdomain no;    # conform to RFC1035
    listen-on-v6 { any; };
//        recursion no;
//        additional-from-auth no;
//        additional-from-cache no;

        forwarders {
                114.114.114.114;
        };
};
```

主要是一些语法选项， 我们可以挑选几个常用的来看

`directory `: 缓存目录相关

`recursion`: 是否支持递归查询， 比如cname到自己解析的 domain，是否继续查询

`forwarders`: 默认上次服务器, 如果查询不到， 选择该默认dns server

其他可以参考详细文档： ftp://ftp.isc.org/isc/bind/9.6-ESV-R5/doc/arm/Bv9ARM.ch06.html

我们在看下`named.conf.local` 文件内容

```
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";
```
主要是加载解析哪些域名， 类似nginx 针对指定server 子配置

下面我们具体配置来解析我们自己配置的域名
我先订以下实践目标


1. www.litongxue.com 到 IP 119.119.119.119, 主要用于理解 域名到IP的map关系

2. ns.litongxue.com cname到 www.baidu.com， 主要用于理解cname的配置方式

3. 172.18.2.42 解析到域名 www.youtube.com， 主要理解PTR，根据IP到domain的反解析

4. 新增bind9日志， 验证DNS采用的迭代查询方式。


#### 实践目标1

www.litongxue.com 到 IP 119.119.119.119, 主要用于理解 域名到IP的map关系



`named.conf.local`文件新增如下内容：

```
zone "litongxue.com" {
    type master;
    file "/etc/bind/zones/db.litongxue.com";
};
```
这里的zone可以理解为域

type 类型master， bind9支持主从服务器， 这里采用默认配置

file， 主要是加载指定的文件， 用来描述我们的 资源记录类型


我们新建`/etc/bind/zones/db.litongxue.com`文件

```
;
; BIND data file for local loopback interface
$TTL    604800 #过期时间
@        IN      SOA     ns1.litongxue.com. admin.litongxue.com. (
    2006061102  ; Serial， #序列串，从服务器根据此值校验是否从主同步
    21600 ; Refresh
    1800 ; Retry
    604800 ; Expire
)   86400 ; Negative Cache TTL
;
;

; name servers - NS records
     IN      NS      ns1.litongxue.com. #域名服务器

; name servers - A records
ns1.litongxue.com.          IN      A      1.1.1.1
www.litongxue.com.          IN      A      119.119.119.119 

```
进入文件夹

`cd /etc/bind/zones/`

执行校验指定， 判断文件是否有语法错误

`sudo named-checkzone litongxue.com db.litongxue.com`

输出如下
 
```
lt@node02:/etc/bind/zones$ sudo named-checkzone litongxue.com db.litongxue.com
zone litongxue.com/IN: loaded serial 2006061102
OK
```


现在重启bind9

`sudo service bind9 restart`


我们执行dig命令用来验证

```
➜  ~ dig  @192.168.50.245  www.litongxue.com

; <<>> DiG 9.8.3-P1 <<>> @192.168.50.245 www.litongxue.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 37952
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1

;; QUESTION SECTION:
;www.litongxue.com.		IN	A

;; ANSWER SECTION:
www.litongxue.com.	604800	IN	A	119.119.119.119 =============验证没有问题

;; AUTHORITY SECTION:
litongxue.com.		604800	IN	NS	ns1.litongxue.com.

;; ADDITIONAL SECTION:
ns1.litongxue.com.	604800	IN	A	1.1.1.1

;; Query time: 1 msec
;; SERVER: 192.168.50.245#53(192.168.50.245)
;; WHEN: Sun Jan 13 23:10:03 2019
;; MSG SIZE  rcvd: 85
```

#### 实践目标2

ns.litongxue.com cname到 www.baidu.com， 主要用于理解cname的配置方式

对`/etc/bind/zones/db.litongxue.com`新增以下内容：

`ns.litongxue.com.          IN      CNAME   www.baidu.com.`

文件内容如下：

```
;
; BIND data file for local loopback interface
$TTL    604800
@        IN      SOA     ns2.litongxue.com. admin.litongxue.com. (
    2006061102  ; Serial
    21600 ; Refresh
    1800 ; Retry
    604800 ; Expire
)   86400 ; Negative Cache TTL
;
;

; name servers - NS records
     IN      NS      ns1.litongxue.com.

; name servers - A records
ns1.litongxue.com.          IN      A      1.1.1.1
www.litongxue.com.          IN      A      119.119.119.119
ns.litongxue.com.          IN      CNAME   www.baidu.com. #========新增内容
```
校验文件，重启, dig命令进行验证

```
➜  ~ dig  @192.168.50.245  ns.litongxue.com

; <<>> DiG 9.8.3-P1 <<>> @192.168.50.245 ns.litongxue.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 48265
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 5, ADDITIONAL: 5

;; QUESTION SECTION:
;ns.litongxue.com.		IN	A

;; ANSWER SECTION:
ns.litongxue.com.	604800	IN	CNAME	www.baidu.com. =============验证成功
www.baidu.com.		1200	IN	CNAME	www.a.shifen.com.
www.a.shifen.com.	300	IN	A	61.135.169.125
www.a.shifen.com.	300	IN	A	61.135.169.121

;; AUTHORITY SECTION:
a.shifen.com.		1200	IN	NS	ns4.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns1.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns5.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns3.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns2.a.shifen.com.

;; ADDITIONAL SECTION:
ns1.a.shifen.com.	1200	IN	A	61.135.165.224
ns2.a.shifen.com.	1200	IN	A	220.181.57.142
ns3.a.shifen.com.	1200	IN	A	112.80.255.253
ns4.a.shifen.com.	1200	IN	A	14.215.177.229
ns5.a.shifen.com.	1200	IN	A	180.76.76.95

;; Query time: 2963 msec
;; SERVER: 192.168.50.245#53(192.168.50.245)
;; WHEN: Sun Jan 13 23:18:10 2019
;; MSG SIZE  rcvd: 287
```
#### 实践目标3

172.18.2.42 解析到域名 www.youtube.com， 主要理解PTR，根据IP到domain的反解析


`named.conf.local`文件新增以下

```
zone "2.18.172.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.2.18.172";
};
```

这里需要以in-addr.arpa 指定后缀结尾， IP需要翻转顺序

新建`/etc/bind/zones/db.2.18.172` 文件， 内容如下：

```
$TTL    604800
@       IN       SOA      youtube. youtube.com. (
        2006061101 ; Serial
        21600 ; Refresh
        1800 ; Retry
        604800 ; Expire
)       86400 ; Negative Cache TTL
; name servers
      IN      NS      ns1.youtube.com.

; PTR Records
42   IN      PTR     ns1.youtube.com.    ; 172.18.2.42

```

我们使用dig命令进行验证：

```
➜  ~ dig -x 172.18.2.42  @192.168.50.245

; <<>> DiG 9.8.3-P1 <<>> -x 172.18.2.42 @192.168.50.245
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 27648
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1

;; QUESTION SECTION:
;42.2.18.172.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
42.2.18.172.in-addr.arpa. 604800 IN	PTR	www.youtube.com. ======验证成功

;; AUTHORITY SECTION:
2.18.172.in-addr.arpa.	604800	IN	NS	ns1.youtube.com.

;; ADDITIONAL SECTION:
ns1.youtube.com.	66	IN	A	66.220.147.47

;; Query time: 1 msec
;; SERVER: 192.168.50.245#53(192.168.50.245)
;; WHEN: Sun Jan 13 23:36:34 2019
;; MSG SIZE  rcvd: 105
```

####  实践目标4

新增bind9日志， 验证DNS采用的迭代查询方式。

named.conf.options文件新增以下内容

```
logging {
     channel default_log {
          file "/var/named/log/default" versions 3 size 20m;
          print-time yes;
          print-category yes;
          print-severity yes;
          #severity info;
          severity debug 3;
};
     category queries { default_log; };
     category network {  default_log; };
     category  default {  default_log; };
     category general {  default_log; };
     category config {  default_log; };
     category resolver {  default_log; };
     category client {  default_log; };
     category update {  default_log; };
     category dispatch {  default_log; };
     category dnssec {  default_log; };

     category xfer-in {  default_log; };
     category xfer-out {  default_log; };
     category lame-servers {  default_log; };
};
```

主要目的是增加日志模块， 并且我们把日志都统一打到 `/var/named/log/default` 文件，

如果文件提示没有写权限， 需要修改文件权限为0777， 并且 需要修改apparmor， 


```
编辑`/etc/apparmor.d/local/usr.sbin.named` 新增
/var/named/log/default rw,

重启：
sudo service apparmor  restart
查看状态
sudo service apparmor  status
```


主要参考以下文章: https://askubuntu.com/questions/172030/how-to-allow-bind-in-app-armor, 


category 主要是声明需要收集哪些模块的日志

重启bind9, 我们查看输出

```
tail -f -n 100 /var/named/log/default

dig请求

dig cs.mfa.gov.cn  @192.168.50.245
```

输出如下：

```
13-Jan-2019 23:47:59.423 client: debug 3: client 192.168.50.234#54843: UDP request
13-Jan-2019 23:47:59.423 security: debug 3: client 192.168.50.234#54843: request is not signed
13-Jan-2019 23:47:59.424 security: debug 3: client 192.168.50.234#54843: recursion available
13-Jan-2019 23:47:59.424 client: debug 3: client 192.168.50.234#54843: query
13-Jan-2019 23:47:59.425 queries: info: client 192.168.50.234#54843 (cs.mfa.gov.cn): query: cs.mfa.gov.cn IN A + (192.168.50.245)
13-Jan-2019 23:47:59.425 security: debug 3: client 192.168.50.234#54843 (cs.mfa.gov.cn): query (cache) 'cs.mfa.gov.cn/A/IN' approved
13-Jan-2019 23:47:59.426 client: debug 3: client 192.168.50.234#54843 (cs.mfa.gov.cn): replace
13-Jan-2019 23:47:59.426 general: debug 3: clientmgr @0x7f82accdb458: get client
13-Jan-2019 23:47:59.427 general: debug 3: clientmgr @0x7f82accdb458: recycle
13-Jan-2019 23:47:59.427 resolver: debug 1: fetch: cs.mfa.gov.cn/A
13-Jan-2019 23:47:59.428 client: debug 3: client @0x7f82a00a9720: udprecv
13-Jan-2019 23:47:59.428 resolver: debug 1: fetch: ./NS =============>获取根服务器
13-Jan-2019 23:48:00.194 resolver: debug 1: fetch: ns1.cdns.cn/A =====>请求顶级域名服务器
13-Jan-2019 23:48:00.194 resolver: debug 1: fetch: ns2.cdns.cn/A
13-Jan-2019 23:48:00.195 resolver: debug 1: fetch: ns3.cdns.cn/A
13-Jan-2019 23:48:00.254 database: debug 3: DNS_EVENT_ADBMOREADDRESSES
13-Jan-2019 23:48:00.255 database: debug 3: DNS_EVENT_ADBMOREADDRESSES
13-Jan-2019 23:48:00.477 resolver: debug 1: fetch: cs.mfa.gov.ccgslb.com.cn/A =====>请求次顶级域名服务器
13-Jan-2019 23:48:00.669 database: debug 3: DNS_EVENT_ADBMOREADDRESSES
13-Jan-2019 23:48:01.438 resolver: debug 1: fetch: hpcc-page.cnc.ccgslb.com.cn/A
13-Jan-2019 23:48:01.480 resolver: debug 3: received packet from 219.146.210.162#53 (no opt):
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id:  65056
```

跟我们猜测一致， 采用迭代方式， 但dns服务器每次均缓存，需要多次更换域名测试



bind9我们新增加 forwarder, 如果域名解析服务器没有命中， 我们则请求上级域名服务器，比如8.8.8.8

`named.conf.options`option中新增

```
        forwarders {
                114.114.114.114; //下一个域名服务器
        };
        forward only; //只会请求forward中的域名服务器
```

我们再使用dig验证todo


####通信具体协议

一般采用udp协议， 这块还需要抓包验证

#### 总结

对dns加深理解。


#### 参考

0. ftp://ftp.isc.org/isc/bind/9.6-ESV-R5/doc/arm/Bv9ARM.ch06.html

1. https://zhuanlan.zhihu.com/p/31568450

2. https://deepzz.com/post/dns-recording-type.html


4. https://www.jianshu.com/p/37a5df5ba474

5. https://ephen.me/2016/dns-rr/

6. https://klionsec.github.io/2017/12/11/Dns-tips/

7. https://wiki.archlinux.org/index.php/BIND_(简体中文)
8. https://www.digitalocean.com/community/tutorials/how-to-configure-bind-as-a-caching-or-forwarding-dns-server-on-ubuntu-14-04
9. http://wiki.ubuntu.org.cn/Bind9%E5%AE%89%E8%A3%85%E8%AE%BE%E7%BD%AE%E6%8C%87%E5%8D%97






