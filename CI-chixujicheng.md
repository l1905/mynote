gitlab-pipeline.md## 持续集成概述


### 什么是持续集成

引用维基百科定义
> 持续集成（英语：Continuous integration，缩写CI）是一种软件工程流程，是将所有软件工程师对于软件的工作副本持续集成到共享主线（mainline）的一种举措
 
我理解更通俗的语言的是， 我们持续(一天多次)将自己代码从分支提交合并到到158， 230，并且上线。

但和我们目前最大的区别是持续集成，必须通过自动化测试(这里一般是单元测试， 集成测试)

集成首先在于交流，它使其他成员能够看到你所做的修改。在这种频繁的交流下，大家都能很快地知道开发过程中所做的修改。

#### 本地自己构建测试成功

在向主线提交代码之前，开发人员必须保证「本地」构建成功。这当然也包括使测试全部通过。另外，在提交之前需要更新本地代码以匹配主线代码，然后在本地解决主线代码与本地代码之间的冲突，再在本地进行构建。如果构建成功，便可以向主线提交代码了。

在这种频繁提交下，开发者可以快速地发现自己代码与他人代码之间的冲突。快速解决问题的关键在于快速地发现问题。几个小时的提交间隔使得代码冲突也可以在几个小时内发现，此时大家的修改都不多，冲突也不大，因此解决冲突也很简单。对于好几周都发现不了的冲突，通常是很难解决的。

每个开发者每天都应当向代码库进行提交。在实践中，越是频繁提交，可能导致冲突的地方就越少，因而也越容易发现。

保证自己本地自测成功

#### 保证develop(158),release(230)主代码健康
有了每日提交，也就又了每日测试，为了使主线处于健康无bug状态。但是在实践中，的确有出错的时候，原因

1. 在于纪律——有人并没有在提交之前进行本地更新和构建。
2. 不同开发机之间的环境不同也是一个原因。

因此，你应该保证在集成机上进行构建，只有当「集成机」上构建成功后，才表明你的任务完成了。由于提交者需要对自己的提交负责，他就得盯着主线上的构建，如果失败，马上修改。如果下班之前你提交的修改失败了，那么，对不起，请修改好了才回家。

这里的集成机是指 独立的测试环境

因此我们需要 当主线代码(develop,release)有合并提交时， 自动告知测试环境， 测试环境自动帮我们构建项目

也就是代码仓库对commit操作配置了钩子（hook），只要提交代码或者合并进主干，就会跑自动化测试。

自然这里跑自动化测试需要一个环境， 就是我们下面要讲的gitlab-runner

持续构建的重点在于，如果主线构建失败，你应该马上进行修改。在持续集成中，你一直是在一个稳定的代码库基础上进行开发。主线构建失败并不是一件坏事，但是，如果这样的情况经常发生，那么就意味着开发人员对于本地更新并没在意或者在提交之前并没在本地构建。主线构建一旦失败，必须马上修正。为了避免主线构建失败


#### 快速构建

1. 持续集成的关键在于快速反馈，需要长时间构建的CI是极其糟糕的。会浪费开发时间
2. 可能最好的解决办法是引入阶段性构建（也叫构建管道或者部署管道），因为构建事实上是分阶段性的


### 持续集成的优点

1. 降低风险
2. 持续集成并不能消除bug，却能帮你快速的发现bug并予以清除。

持续集成更像是自测试的代码。当遇到bug时，由于你只做了很小的修改，这样便大大缩小的bug的查找范围。另外，由于是你刚写的代码，你还记得很清楚，因此也使查找bug更加容易。

Bug也存在积累性，bug越多，越难清除。部分原因在于bug之间存在牵连。另外也存在心理因素，bug一多，人便没那么多精力去修了


持续集成更像是自测试的代码。当遇到bug时，由于你只做了很小的修改，这样便大大缩小的bug的查找范围。


### 持续集成的缺点

1. 构建一个自动化测试包需要大量的工作，包括不断努力以覆盖新功能，并依照特定情境进行程序码修改。 ----工作量加大
2. 增加的价值取决于测试的质量以及代码的真实可测性。 -------对测试代码质有较高要求


### 我们怎么接入持续集成


常见的持续集成工具有

+ Jenkins: 老牌持续集成工具， 跨平台(git, svn)
+ Travis: github提供的自己的持续集成工具，开源项目免费
+ gitlab-ci: gitlab自带， 


参考图：
![12121](https://confluence-team.smzdm.com/download/attachments/5312421/14_26_18__12_20_2018.jpg?api=v2)

综上分析， 引入持续集成

需要我们本地先跑完测试， 

确保代码没问题， 然后上线合并到develop(158),或者release(230), 当代码合并到158， 230时， 需要触发自动构建测试过程， 保证代码正常。 因此我们需要引入以下工具

1. 单元测试(php选用phpunit类库，来执行单元测试)
2. 构建工具（我们项目代码都放在内部gitlab上，因此选择gitlab-ci)
     
     + 构建环境(自动帮我们执行， 这里我们选用gitlab-ci 的runner来我们进行)
     
     + 自动构建内容(需要在项目根目录定义.gitlab-ci.yaml 定义说明pipeline过程)

     
下面具体章节，我们详细讲解gitlab-ci, phpunit


参考：

持续集成（Continuous Integration）

持续交付（Continuous Delivery）

持续部署（Continuous Deployment）

1. [Martin Fowler的《持续集成》](https://blog.csdn.net/zhoudaxia/article/details/37613049 )
2. [The Product Managers’ Guide to Continuous Delivery and DevOps](https://www.mindtheproduct.com/2016/02/what-the-hell-are-ci-cd-and-devops-a-cheatsheet-for-the-rest-of-us/)
3. [http://www.ruanyifeng.com/blog/2015/09/continuous-integration.html](http://www.ruanyifeng.com/blog/2015/09/continuous-integration.html)
4. [https://www.martinfowler.com/articles/continuousIntegration.html](https://www.martinfowler.com/articles/continuousIntegration.html)
5. [https://zh.wikipedia.org/wiki/%E6%8C%81%E7%BA%8C%E6%95%B4%E5%90%88](https://zh.wikipedia.org/wiki/%E6%8C%81%E7%BA%8C%E6%95%B4%E5%90%88)

