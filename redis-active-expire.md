## Redis主动过期-线上问题记录

### 背景

前几天DBA突然反馈，线上评论的redis-cache实例，内存占用逐渐增加， 因为是缓存库，都有设置过期时间，并且设置时间相对较短，比如一分钟左右。不太可能积压占用太多内存，目前是使用1G内存，已经安全使用几年时间


1.  首先我们排查是否有新上线 写redis操作

 > 排查未发现新的写操作


2. 排查我们最近新上线内容

 > 发现最近上线的作业， 向redis-cache实例中写了一部分小key， 过期时间为一个月， 觉得可能是因为这个引起的内存占用增加， 和DBA沟通，扩容该redis实例为2G内存。 内存相对稳定在占用1.2G左右。 处理到这里， 我们想当然以为已经解决完问题。

3. 间隔三个小时后， DBA发现线上redis实例 内存占用仍然是逐渐增加

 > 我们意识到问题没有解决。

4. 继续怀疑是因为有新写入key导致
 
 > 通过info命令和monitor命令，仍然没有发现持续写入命令， 但DBA通过监控发现KEY是缓慢增加， 我们继续费解。 
 
5. 选择将常用key过期时间缩短， 比如从1分钟缩短为10s

 > 观察后，没有效果
 
6. 怀疑是爬虫 爬区评论文章，导致redis-cache命中率不高导致

 > 通过后台其他监控支持，发现确实有爬虫来爬取数据， 访问量相对较高，但是以前也是会有爬虫来，但没有遇到类似内存占用逐渐增多问题。 但是redis的key总数呈现逐渐增加趋势
 
7. 暂时没有能说的通的解决方案， 内存占用持续增加
 
 > DBA继续扩容redis实例，新增2G内存

8.  继续是怀疑是爬虫爬取的问题

 > 线上将redis-cache从业务逻辑代码中去掉， 直接用MYSQL挡前台流量。 发现redis 内存占用降低， 基本可以确定是爬虫刷数据导致， 但是不清楚内在原因
 
9. 第二天复盘原因

 > 发现爬虫爬取时，写入redis的key大部分是大key， 导致虽然写次数不多，但是能很快占满内存。

10. 继续追内在原因， 怀疑可能是redis过期策略导致。

  > 查询一些文章和redis源码，发现确实是redis主动过期策略的锅。


### 梳理redis过期策略

设置过期时间的redis-key当到达过期时间点时， 会有两种过期策略：

1. 被动过期，再次读取这个key的时候，判断key是否过期

2. 主动过期， redis起一个后台任务， 每秒钟执行10次(通过hz参数控制)，在每次执行过程中：
    1. 从{带过期时间的key集合}中随机获取 25个key
    2. 检查这个25个key中，达到真正过期时间了， 则删除掉， 并且记录删除的key数
    3. 检查删除的key数， 如果小于5个， 则退出， 如果大于5个，则继续循环

昨天出现的情况是
1. 向comment-cache导入举报数据, 导了100万个 小key， 并且过期时间为一个月。 
    导致带过期时间的key集合非常大。

2. 昨天有来刷最热评论接口的，key的使用率非常低，过期时间为10s， 基本没有被动过期的。并且key值比较大。


因此最热评论的key的过期策略，会使用主动过期， 因为带过期时间的key集合非常大， 随机获取25个key， 则时间是过期的key总量非常小，所以过期效率非常低， 导致内存逐渐增大 。

### 一句话总结

长时间不过期的redis-key 如果太多， 则会影响被动过期的效率。 

### 因此给我的经验经验教训是

1. 长时间不过期的redis-key不要太多
2. 单Key不要过大
3. 如果对redis底层过期策略足够熟悉

### 参考文章

1. https://yq.aliyun.com/articles/257459


 
 




