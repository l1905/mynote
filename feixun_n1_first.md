# 斐讯n1折腾流水记录

## 背景

刷`v2ex` 的树莓派帖子， 发现有网友推荐 斐讯n1盒子， 说可玩性， 性价比都很高，cpu比树莓派3B强不少， 顿时来兴趣， 一顿研究， 顺利从 `拼多多`（斐讯在京东淘宝都已经搜不到， 拼多多新平台， 应该还是监管不严)上下单入手， 带着 `双母USB`线， 顺利从拼多多以`92`rmb下单，也是实现了从拼多多的零下单记录。

购买主要实现的功能是：安装openwrt，实现愉快的事情， 之前都是在电脑端，或者手机上安装的酸酸乳客户端， 总体还不是特别方便


## 开箱

本身对盒子没太多研究，粗略介绍。

机器相对家里提供的`iptv机顶盒` 要厚一些， 个头整体要大一小圈

盒子没有电源开关， 通电即是开机。通电后，前面有个logo会照亮， 以确定是否开机.

 前侧是一排接口， 主要有以下：

* 电源接口 x 1；
* 千兆网口 x 1；
* HDMI x 1；
* USB x 2；

## 设备资源准备

工具列表：

 1. 斐讯n1
 2. USB鼠标：主要用来点击打开adb模式
 3. HDMI： 连接盒子到外接显示装置，比如电视或者显示器
 4. 双公头USB: 主要用来刷机使用
 5. 盒子网线： 用来连接路由器，获取IP地址
 6. U盘：用来刷入openwrt镜像，或者系统镜像
 7. 笔记本电脑： 准备镜像包(openwrt和

资源列表

1. openwrt镜像
2. 系统镜像
3. 刷机教程
4. balenaEtcher软件(用来镜像烧录）

镜像下载地址(学习资料1为降级工具，学习资料2为Armbian镜像，学习资料3为op镜像）

https://onedrive.live.com/?authkey=%21ALxRkWaUBFbKBP8&id=1CDAF5E6FDFF7567%21216&cid=1CDAF5E6FDFF7567

保险起见， 我将上述共享资源下载到了自己的onedrive盘中

 
## 降级

低版本禁止刷机操作， 因此需要降级到指定版本

这里网上教程已经相对较全, 我主要参考下面的一篇， 摘抄过来如下：

```
1.降级
1）盒子插入网线、USB鼠标、双公头USB刷机线；
2）并用HDMI线接入电视或带HDMI的显示器中；
3) 双公头USB刷机线另一端接入电脑USB口；
4）盒子网线另一端连入局域网，插入电源适配器；
5）上电开机后，记录盒子有线网口获取到的IP；(这里可以通过主路由器查看)
6）鼠标连续点击4次固件版本号，开启adb模式；
7）电脑端，使电脑能够ping通盒子IP；
8）使用降级工具，选择N1，填入盒子IP，点击降级；
9）工具提示(recovery)降级成功，断电重启盒子完成降级。
```

我发现网上降级方式有很多种方式， 也是因为斐讯越来越火爆， 逐渐出现更简便的降级教程出现。

我参考的这篇文章，降级傻瓜化操作，提供一个gui操作界面， 进行降级操作。

这里可能存在的问题：

1. 刷入降级时， 可能会提示连接超时，导致刷机不成功

如果提示错误，并且盒子不受控制， 这时候需要拔线断电重启，等指示灯闪烁，重新再试， 我这边试了大约10次左右才刷成功。 不要过度担心刷成砖。

## 制作openwrt的U盘镜像

2019.05.13-lean-openwrt-phicomm-n1-armvirt-64-bycheng.img
将提供的.img镜像文件，通过balenaEtcher软件，把镜像文件写入U盘。


## 设置盒子从U盘启动

```
1）将制作好的U盘插入降级后的盒子当中；
2）在工具文件夹中打开PowerShell，执行(这里就是进入刷机工具文件目录, 管理员权限到开powerShell)
./adb connect 192.168.10.186 (这里的IP是我们的n1 IP)
./adb shell reboot update (这里设定从u盘启动）
3）查看盒子HDMI画面，出现四只企鹅则U盘OpenWRT启动正常；
4）若出现机器人倒地，请多换几个U盘进行尝试。
```

这一步的目的是，将openwrt刷到u盘中， 盒子从u盘启动。


## 将n1设置成旁路由

参考摘要

```
1）登陆主路由web界面，关闭主路由的酸xx，并关闭LAN参数中IPV6通告。(我主路由没有酸酸乳， 因此省略)
2）用网线直连盒子和PC，并检查获取到的IP地址；
3）登陆盒子web界面，进入LAN参数设置：
     a.修改LANIP为：192.168.10.3(n1盒子的内网IP)
     b.修改网关为：192.168.10.1(主路由IP)
     c.修改DNS服务器为：114.114.114.114
     d.关闭IPV6通告
4）用网线直连盒子和主路由，并让盒子重新上电；
5）PC端ping 192.168.10.3，正常后，浏览器登陆盒子web界面192.168.10.3：
     a.检查盒子是否能够正常上网；
     b.开启盒子的酸xx；
     c.在LAN参数中设置强制使用此网络的DHCP服务；
     d.断电重启盒子。
6）PC禁用网卡，重新获取IP，检查网关是否为：192.168.10.3(主路由器IP）
```

openwrt默认地址是`192.168.10.1`，账号`root`, 密码`password`

这里出现的主要问题是：

```使用旁路由不稳定 ```

网管经常还是获取的主路由的网关，即openwrt的强制使用此网络的DHCP功能不稳定。 我怀疑如果主路由是openwrt的话， 功能就会稳定了。

但是我们可以手动获取IP, 设置静态IP的网关为旁路由IP， 同样可以实现愉快的酸酸乳。

macos上设置，遇到的问题是： 设置的网关是全局的， 并且需要「增加DNS解析」到旁路由IP
， 我因为经常要在公司和家 同时使用一个macos， 导致经常需要修改网关。

找到的解决解决方案是：
点击屏幕左上角苹果图标---->选择位置----->网络偏好位置--->顶部位置下拉框--->编辑位置。 

增加两个位置「公司」「家」， 针对「家」位置修改对应的TCP/IP 和DNS配置， 此次修改， 不影响「公司」下的 TCP/DNS配置

到时候我们

点击屏幕左上角苹果图标---->选择位置 ----> 选择「家」或者公司「位置」即可


后来觉得还是不方便， 从网上找到更好的网络调整方案， 摘要如下：

```
设置步骤
主路由无需做任何变动。
N1 网口直连电脑，网络地址使用DHCP自动获取。
浏览器打开 192.168.1.1，进入Openwrt，默认账户名root，密码 password 。
点击「网络」-「接口」-「修改 br-lan接口」，将静态 IPv4 地址修改为主路由网段中的一个地址，例如 192.168.1.2。
再将网关设置为主路由地址，例如 192.168.1.1。
IPv4 广播设置为 192.168.1.255。
DNS 地址根据本地网络情况设置。
同时下方「DHCP服务器」，勾选「忽略此接口」。
保存并应用配置，然后将 N1 连接到主路由的 LAN 口。

手动指定需要 N1 服务的设备，网关地址和 DNS 服务器为192.168.1.2。

模式二：主路由开 DHPC + N1 关DHPC (全局)
该配置下，所有设备都会使用 N1 作为网关和 DNS 服务。

方法一
N1 的设置与模式一相同。
进入主路由，将主路由的 DHCP 的默认网关修改为192.168.1.2，同时将 DNS 服务器也修改为 192.168.1.2。

方法二（适用于主路由为Openwrt）
N1 的设置与模式一相同。
进入主路由，「网络」-「接口」-「LAN」-「DHCP 服务器」-「高级设置」
在「DHCP 选项」中，添加两条参数，3,192.168.1.2，6,192.168.1.2 。
保存并应用配置即可。

模式三：主路由开 DHPC + N1 开 DHPC (全局)
该配置下，N1 会成为首选 DHCP 服务器，主路由 DHCP 只用于给 N1 分配地址

设置步骤
主路由无需设置
N1 设置与模式一基本相同，但是，「DHCP服务器」取消勾选「忽略此接口」
「高级设置」中，勾选「强制」
保存并应用配置。

PS：我尝试过该配置，不太稳定，有时候 DHCP 地址还是会分配在主路由下面，因此该种方法只作为参考
```


## 直接将openwrt刷到 n1的emcc中


前面是刷入到U盘， 单独占用u盘，还是觉得浪费， 因此选择将openwrt直接刷到n1的emcc中

主要参考如下

```
1.第一步制作XQ7大神的Armbian系统 U盘镜像

2.插入网线，U盘启动N1盒子(参考前面流程)

3.在路由器中找到盒子的IP

4.用Xshell软件ssh登陆到盒子
账号：root
密码：1234
说明：Xshell连接成功后，第一个是让输入默认密码1234，第二是输入新密码，不能太短也不能与默认密码接近(可输入password)，第三个是确认新密码(password)。提示创建新用户名，不创建，ctrl+c取消即可。用新密码重新连接。

5.执行脚本
/boot/create-mbr-linux.sh
./install.sh
注：脚本会帮我们将eMMC分成两个分区，并将Armbian写入到eMMC中

6.通过文件传输软件，将OpenWRT镜像文件上传到盒子root目录, 这里可以选择scp,或者sftp，或者filezila

7.完成后，创建一个emmc2文件夹
mkdir /emmc2

8.将eMMC其中一个分区(Armbian所在的分区)挂载到新创建的emmc2文件夹
mount /dev/mmcblk1p2 /emmc2

9.删除Armbian的所有文件
rm -rf /emmc2/*

10.挂载我们的OpenWRT镜像
losetup -P -f –show 2019.05.19-openwrt-phicomm-n1-armvirt-64-bycheng.img
(注意：show前面是两个英文的”-“，如果你执行此命令时报错，务必检查一下）

11.挂载到指定文件夹
mount /dev/loop0p2 /media

12.将OpenWRT的所有文件拷贝到Armbian文件夹
cp -R /media/* /emmc2

13.卸载挂载
umount /media
losetup -d /dev/loop0
umount /emmc2

14.重启盒子
先拔盒子电源，然后取下U盘，再插入电源
```


## 总结

1. 单纯看文本内容， 总觉得还是不详细， 建议还是结合视频+文本内容，一并操作，效率相对较高。


## 后期操作

1. 刷Armbian， 当linux服务器
2. 刷机顶盒， 当机顶盒使用


## 参考资料

1. [XQ7系统镜像](https://www.right.com.cn/forum/thread-394823-1-1.html)
2. [详细装机过程-附视频](https://www.maxlicheng.com/embedded/36.html)
3. [网络问题排查](https://injoy.work/archives/e806f8ac.html)